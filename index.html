<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é£ä¹¦å¤šç»´è¡¨æ ¼æ°”æ³¡å›¾æ’ä»¶</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'PingFang SC', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .plugin-container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      overflow: hidden;
    }
    
    .plugin-header {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
    }
    
    .plugin-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="3" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
      opacity: 0.3;
    }
    
    .plugin-header h1 {
      font-size: 2.5em;
      font-weight: 300;
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
    }
    
    .plugin-header p {
      font-size: 1.1em;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }
    
    .plugin-content {
      padding: 30px;
    }
    
    .config-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid #e9ecef;
      transition: all 0.3s ease;
    }
    
    .config-section:hover {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
    }
    
    .config-section h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 1.4em;
      font-weight: 500;
      display: flex;
      align-items: center;
    }
    
    .config-section h2::before {
      content: '';
      width: 4px;
      height: 20px;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      margin-right: 12px;
      border-radius: 2px;
    }
    
    .input-group {
      margin-bottom: 20px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #495057;
      font-size: 0.95em;
    }
    
    .input-group input,
    .input-group select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1em;
      transition: all 0.3s ease;
      background: white;
    }
    
    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: #4facfe;
      box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
    }
    
    .input-group input::placeholder {
      color: #adb5bd;
    }
    
    .btn {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 500;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .status {
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 0.9em;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    .status.success {
      background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.info {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .chart-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }
    
    #chartContainer {
      height: 500px;
      width: 100%;
      padding: 20px;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .fade-in {
      animation: fadeIn 0.6s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .table-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .info-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e9ecef;
      text-align: center;
    }
    
    .info-card .label {
      font-size: 0.8em;
      color: #6c757d;
      margin-bottom: 5px;
    }
    
    .info-card .value {
      font-size: 1.2em;
      font-weight: 600;
      color: #2c3e50;
    }
    
    @media (max-width: 768px) {
      .plugin-container {
        margin: 10px;
        border-radius: 12px;
      }
      
      .plugin-header {
        padding: 20px;
      }
      
      .plugin-header h1 {
        font-size: 2em;
      }
      
      .plugin-content {
        padding: 20px;
      }
      
      .config-section {
        padding: 20px;
      }
      
      #chartContainer {
        height: 400px;
      }
    }
  </style>
</head>
<body>
  <div class="plugin-container fade-in">
    <div class="plugin-header">
      <h1>ğŸ“Š é£ä¹¦å¤šç»´è¡¨æ ¼æ°”æ³¡å›¾æ’ä»¶</h1>
      <p>ä¸“ä¸šçš„æ•°æ®å¯è§†åŒ–å·¥å…·ï¼Œè®©æ•°æ®åˆ†ææ›´ç›´è§‚</p>
    </div>
    
    <div class="plugin-content">
      <!-- è¡¨æ ¼ä¿¡æ¯å±•ç¤ºåŒº -->
      <div class="config-section" id="table_info_section" style="display: none;">
        <h2>ğŸ“‹ è¡¨æ ¼ä¿¡æ¯</h2>
        <div class="table-info">
          <div class="info-card">
            <div class="label">è¡¨æ ¼åç§°</div>
            <div class="value" id="table_name">-</div>
          </div>
          <div class="info-card">
            <div class="label">Base ID</div>
            <div class="value" id="table_app_token">-</div>
          </div>
          <div class="info-card">
            <div class="label">è¡¨ID</div>
            <div class="value" id="table_table_id">-</div>
          </div>
          <div class="info-card">
            <div class="label">è®°å½•æ•°</div>
            <div class="value" id="table_record_count">-</div>
          </div>
        </div>
      </div>
      
      <!-- è‡ªåŠ¨æ£€æµ‹é…ç½® -->
      <div class="config-section">
        <h2>ğŸ” è‡ªåŠ¨æ£€æµ‹é…ç½®</h2>
        <div class="input-group">
          <button class="btn" id="btn_auto_detect" onclick="autoDetectTable()">
            <span id="auto_detect_text">ğŸ¯ è‡ªåŠ¨æ£€æµ‹å½“å‰è¡¨æ ¼</span>
          </button>
        </div>
        <div id="auto_detect_status" class="status" style="display: none;"></div>
      </div>
      
      <!-- æ‰‹åŠ¨é…ç½® -->
      <div class="config-section">
        <h2>âš™ï¸ æ‰‹åŠ¨é…ç½®</h2>
        <div class="input-group">
          <label for="cfg_app_token">Base ID (app_token)</label>
          <input type="text" id="cfg_app_token" placeholder="åœ¨é£ä¹¦å¤šç»´è¡¨æ ¼URLä¸­æ‰¾åˆ°çš„ID">
        </div>
        <div class="input-group">
          <label for="cfg_table_id">è¡¨ID (table_id)</label>
          <input type="text" id="cfg_table_id" placeholder="åœ¨é£ä¹¦å¤šç»´è¡¨æ ¼è¡¨è®¾ç½®ä¸­æ‰¾åˆ°çš„ID">
        </div>
        <button class="btn" id="btn_get_fields" onclick="getFields()">
          <span id="get_fields_text">ğŸ” è·å–å­—æ®µ</span>
        </button>
        <div id="link_status" class="status" style="display: none;"></div>
      </div>

      <div class="config-section">
        <h2>ğŸ“Š é€‰æ‹©å­—æ®µ</h2>
        <div class="input-group">
          <label for="x_field">Xè½´ (æ•°å€¼å­—æ®µ)</label>
          <select id="x_field" disabled>
            <option value="">é€‰æ‹©Xè½´å­—æ®µ</option>
          </select>
        </div>
        <div class="input-group">
          <label for="y_field">Yè½´ (æ•°å€¼å­—æ®µ)</label>
          <select id="y_field" disabled>
            <option value="">é€‰æ‹©Yè½´å­—æ®µ</option>
          </select>
        </div>
        <div class="input-group">
          <label for="size_field">æ°”æ³¡å¤§å° (æ•°å€¼å­—æ®µ)</label>
          <select id="size_field" disabled>
            <option value="">é€‰æ‹©å¤§å°å­—æ®µ</option>
          </select>
        </div>
        <div class="input-group">
          <label for="name_field">æ°”æ³¡åç§° (æ–‡æœ¬å­—æ®µ)</label>
          <select id="name_field" disabled>
            <option value="">é€‰æ‹©åç§°å­—æ®µ</option>
          </select>
        </div>
        <button class="btn" id="btn_generate_chart" onclick="generateChart()" disabled>
          <span id="generate_chart_text">ğŸ“ˆ ç”Ÿæˆæ°”æ³¡å›¾</span>
        </button>
      </div>

      <div class="config-section chart-container">
        <h2>ğŸ“Š æ°”æ³¡å›¾å¯è§†åŒ–</h2>
        <div id="chartContainer"></div>
        <div id="chart_status" class="status" style="display: none; margin-top: 20px;"></div>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let chart = null;
    let currentTableInfo = null;
    let availableFields = [];
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initializePlugin();
    });
    
    // åˆå§‹åŒ–æ’ä»¶
    async function initializePlugin() {
      try {
        // æ£€æŸ¥æ˜¯å¦åœ¨é£ä¹¦ç¯å¢ƒä¸­
        if (window.parent !== window && window.parent.postMessage) {
          // è¯·æ±‚è·å–å½“å‰è¡¨æ ¼ä¿¡æ¯
          requestTableInfo();
        } else {
          showStatus('info', 'è¯·æ‰‹åŠ¨è¾“å…¥è¡¨æ ¼ä¿¡æ¯è¿›è¡Œé…ç½®', 'link_status');
        }
      } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        showStatus('error', 'æ’ä»¶åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'link_status');
      }
    }
    
    // è¯·æ±‚è¡¨æ ¼ä¿¡æ¯
    function requestTableInfo() {
      try {
        window.parent.postMessage({
          type: 'get_table_info',
          plugin_id: 'feishu_bubble_chart_plugin'
        }, '*');
        
        // ç›‘å¬æ¶ˆæ¯è¿”å›
        window.addEventListener('message', handleTableInfoMessage);
      } catch (error) {
        console.error('è¯·æ±‚è¡¨æ ¼ä¿¡æ¯å¤±è´¥:', error);
      }
    }
    
    // å¤„ç†è¡¨æ ¼ä¿¡æ¯æ¶ˆæ¯
    function handleTableInfoMessage(event) {
      if (event.data && event.data.type === 'table_info') {
        const tableInfo = event.data.data;
        if (tableInfo) {
          currentTableInfo = tableInfo;
          displayTableInfo(tableInfo);
          // è‡ªåŠ¨å¡«å……è¡¨å•
          document.getElementById('cfg_app_token').value = tableInfo.app_token || '';
          document.getElementById('cfg_table_id').value = tableInfo.table_id || '';
          // è‡ªåŠ¨è·å–å­—æ®µ
          if (tableInfo.app_token && tableInfo.table_id) {
            getFields();
          }
        }
      }
    }
    
    // æ˜¾ç¤ºè¡¨æ ¼ä¿¡æ¯
    function displayTableInfo(info) {
      document.getElementById('table_info_section').style.display = 'block';
      document.getElementById('table_name').textContent = info.name || 'æœªçŸ¥è¡¨æ ¼';
      document.getElementById('table_app_token').textContent = info.app_token || '-';
      document.getElementById('table_table_id').textContent = info.table_id || '-';
      document.getElementById('table_record_count').textContent = info.record_count || '-';
    }
    
    // è‡ªåŠ¨æ£€æµ‹è¡¨æ ¼
    async function autoDetectTable() {
      const btn = document.getElementById('btn_auto_detect');
      const btnText = document.getElementById('auto_detect_text');
      
      btn.disabled = true;
      btnText.innerHTML = '<span class="loading"></span> æ­£åœ¨æ£€æµ‹...';
      
      try {
        // å°è¯•ä»é£ä¹¦ç¯å¢ƒä¸­è·å–è¡¨æ ¼ä¿¡æ¯
        requestTableInfo();
        showStatus('success', 'è‡ªåŠ¨æ£€æµ‹å®Œæˆï¼Œè¡¨æ ¼ä¿¡æ¯å·²è·å–', 'auto_detect_status');
      } catch (error) {
        showStatus('error', 'è‡ªåŠ¨æ£€æµ‹å¤±è´¥: ' + error.message, 'auto_detect_status');
      } finally {
        btn.disabled = false;
        btnText.innerHTML = 'ğŸ¯ è‡ªåŠ¨æ£€æµ‹å½“å‰è¡¨æ ¼';
      }
    }
    
    // è·å–å­—æ®µ
    async function getFields() {
      const app_token = document.getElementById('cfg_app_token').value.trim();
      const table_id = document.getElementById('cfg_table_id').value.trim();
      
      if (!app_token || !table_id) {
        showStatus('error', 'è¯·å¡«å†™Base IDå’Œè¡¨ID', 'link_status');
        return;
      }

      const btn = document.getElementById('btn_get_fields');
      const btnText = document.getElementById('get_fields_text');
      
      btn.disabled = true;
      btnText.innerHTML = '<span class="loading"></span> æ­£åœ¨è·å–å­—æ®µ...';
      
      try {
        const response = await fetch(`/api/bitable/fields?app_token=${encodeURIComponent(app_token)}&table_id=${encodeURIComponent(table_id)}`);
        const data = await response.json();
        
        if (response.ok) {
          availableFields = data.fields;
          populateFields(data.fields);
          showStatus('success', 'å­—æ®µè·å–æˆåŠŸï¼è¯·é€‰æ‹©X/Yè½´å’Œå¤§å°å­—æ®µ', 'link_status');
        } else {
          throw new Error(data.error || 'è·å–å­—æ®µå¤±è´¥');
        }
      } catch (error) {
        showStatus('error', 'é”™è¯¯: ' + error.message, 'link_status');
      } finally {
        btn.disabled = false;
        btnText.innerHTML = 'ğŸ” è·å–å­—æ®µ';
      }
    }
    
    // å¡«å……å­—æ®µä¸‹æ‹‰èœå•
    function populateFields(fields) {
      const fieldSelects = ['x_field', 'y_field', 'size_field', 'name_field'];
      
      fieldSelects.forEach(id => {
        const select = document.getElementById(id);
        select.innerHTML = '<option value="">é€‰æ‹©å­—æ®µ</option>';
        select.disabled = false;
        
        // æ·»åŠ å­—æ®µ
        fields.forEach(field => {
          const option = document.createElement('option');
          option.value = field.id;
          option.textContent = field.name;
          select.appendChild(option);
        });
      });
    }
    
    // ç”Ÿæˆå›¾è¡¨
    async function generateChart() {
      const xField = document.getElementById('x_field').value;
      const yField = document.getElementById('y_field').value;
      const sizeField = document.getElementById('size_field').value;
      const nameField = document.getElementById('name_field').value;
      
      if (!xField || !yField || !sizeField) {
        showStatus('error', 'è¯·é€‰æ‹©Xè½´ã€Yè½´å’Œå¤§å°å­—æ®µ', 'chart_status');
        return;
      }

      const btn = document.getElementById('btn_generate_chart');
      const btnText = document.getElementById('generate_chart_text');
      
      btn.disabled = true;
      btnText.innerHTML = '<span class="loading"></span> æ­£åœ¨ç”Ÿæˆå›¾è¡¨...';
      
      try {
        // è·å–è¡¨æ ¼æ•°æ®
        const app_token = document.getElementById('cfg_app_token').value.trim();
        const table_id = document.getElementById('cfg_table_id').value.trim();
        
        const records = await getTableRecords(app_token, table_id);
        
        if (records.length === 0) {
          showStatus('warning', 'è¡¨æ ¼ä¸­æ²¡æœ‰æ•°æ®', 'chart_status');
          return;
        }
        
        // æ¸²æŸ“å›¾è¡¨
        renderBubbleChart(records, xField, yField, sizeField, nameField);
        showStatus('success', 'æ°”æ³¡å›¾ç”ŸæˆæˆåŠŸï¼', 'chart_status');
        
      } catch (error) {
        showStatus('error', 'ç”Ÿæˆå›¾è¡¨å¤±è´¥: ' + error.message, 'chart_status');
      } finally {
        btn.disabled = false;
        btnText.innerHTML = 'ğŸ“ˆ ç”Ÿæˆæ°”æ³¡å›¾';
      }
    }
    
    // è·å–è¡¨æ ¼è®°å½•
    async function getTableRecords(app_token, table_id) {
      const response = await fetch(`/api/bitable/records?app_token=${encodeURIComponent(app_token)}&table_id=${encodeURIComponent(table_id)}`);
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'è·å–è®°å½•å¤±è´¥');
      }
      
      return data.records || [];
    }
    
    // æ¸²æŸ“æ°”æ³¡å›¾
    function renderBubbleChart(records, xField, yField, sizeField, nameField) {
      if (!chart) {
        chart = echarts.init(document.getElementById('chartContainer'));
      }
      
      // å‡†å¤‡æ•°æ®
      const chartData = records.map(record => {
        const fields = record.fields || {};
        return {
          value: [
            parseFloat(fields[xField]) || 0,
            parseFloat(fields[yField]) || 0,
            parseFloat(fields[sizeField]) || 0
          ],
          name: fields[nameField] || `è®°å½•${record.record_id || ''}`,
          itemStyle: {
            color: `hsl(${Math.random() * 360}, 70%, 60%)`
          }
        };
      }).filter(item => item.value[0] !== 0 || item.value[1] !== 0);
      
      // è·å–å­—æ®µåç§°
      const xFieldName = availableFields.find(f => f.id === xField)?.name || 'Xè½´';
      const yFieldName = availableFields.find(f => f.id === yField)?.name || 'Yè½´';
      const sizeFieldName = availableFields.find(f => f.id === sizeField)?.name || 'å¤§å°';
      
      const option = {
        title: {
          text: `${xFieldName} vs ${yFieldName} æ°”æ³¡å›¾`,
          subtext: `æ°”æ³¡å¤§å°è¡¨ç¤º ${sizeFieldName}`,
          left: 'center',
          textStyle: {
            fontSize: 18,
            fontWeight: 'normal',
            color: '#2c3e50'
          },
          subtextStyle: {
            fontSize: 14,
            color: '#7f8c8d'
          }
        },
        tooltip: {
          trigger: 'item',
          formatter: function(params) {
            return `<div style="padding: 10px;">
              <div style="font-weight: bold; margin-bottom: 5px;">${params.name}</div>
              <div>${xFieldName}: ${params.value[0]}</div>
              <div>${yFieldName}: ${params.value[1]}</div>
              <div>${sizeFieldName}: ${params.value[2]}</div>
            </div>`;
          }
        },
        xAxis: {
          name: xFieldName,
          nameLocation: 'middle',
          nameGap: 30,
          type: 'value',
          nameTextStyle: {
            fontSize: 14,
            color: '#7f8c8d'
          },
          axisLine: {
            lineStyle: {
              color: '#bdc3c7'
            }
          }
        },
        yAxis: {
          name: yFieldName,
          nameLocation: 'middle',
          nameGap: 40,
          type: 'value',
          nameTextStyle: {
            fontSize: 14,
            color: '#7f8c8d'
          },
          axisLine: {
            lineStyle: {
              color: '#bdc3c7'
            }
          }
        },
        series: [{
          type: 'scatter',
          symbolSize: function(data) {
            return Math.sqrt(data[2]) * 5 + 10; // æ ¹æ®æ•°å€¼è°ƒæ•´æ°”æ³¡å¤§å°
          },
          data: chartData,
          emphasis: {
            itemStyle: {
              shadowBlur: 10,
              shadowOffsetX: 0,
              shadowColor: 'rgba(0, 0, 0, 0.5)'
            }
          }
        }],
        animation: true,
        animationDuration: 1000,
        animationEasing: 'cubicOut'
      };
      
      chart.setOption(option, true);
      
      // å“åº”å¼å¤„ç†
      window.addEventListener('resize', function() {
        if (chart) {
          chart.resize();
        }
      });
    }
    
    // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
    function showStatus(type, message, elementId = 'link_status') {
      const statusDiv = document.getElementById(elementId);
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'flex';
      
      // 3ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }
    
    // ç›‘å¬å­—æ®µé€‰æ‹©å˜åŒ–
    document.addEventListener('change', function(e) {
      if (e.target.id === 'x_field' || e.target.id === 'y_field' || e.target.id === 'size_field') {
        const xField = document.getElementById('x_field').value;
        const yField = document.getElementById('y_field').value;
        const sizeField = document.getElementById('size_field').value;
        
        const generateBtn = document.getElementById('btn_generate_chart');
        generateBtn.disabled = !(xField && yField && sizeField);
      }
    });
  </script>
</body>
</html>